import { Comment } from './types';

// AIã¾ã¨ã‚ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹
export interface AISummarizeResponse {
  selected_posts: {
    post_number: number;
    decorations: {
      color: 'red' | 'blue' | 'green' | null;
      size_boost: 'large' | null;
    };
    reason: string;
  }[];
}

// ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ
export function buildAISummarizePrompt(title: string, comments: Comment[]): string {
  const totalPosts = comments.length;

  // ã‚¹ãƒ¬ä¸»ã®ãƒ¬ã‚¹ç•ªå·ã‚’ç‰¹å®š
  const ownerPostNumbers: number[] = [];
  comments.forEach((comment, index) => {
    if (comment.is_talk_owner) {
      ownerPostNumbers.push(index + 1);
    }
  });

  const postsText = comments
    .map((comment, index) => {
      const postNum = index + 1;
      const ownerMark = comment.is_talk_owner ? ' [ã‚¹ãƒ¬ä¸»]' : '';
      return `[${postNum}]${ownerMark} ${comment.body}`;
    })
    .join('\n\n');

  return `ã‚ãªãŸã¯5chã‚¹ãƒ¬ãƒƒãƒ‰ã®ã¾ã¨ã‚è¨˜äº‹ã‚’ä½œæˆã™ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚

ä»¥ä¸‹ã®ã‚¹ãƒ¬ãƒƒãƒ‰ã‹ã‚‰ã€ã¾ã¨ã‚è¨˜äº‹ã«é©ã—ãŸãƒ¬ã‚¹ã‚’é¸æŠã—ã€è£…é£¾ã‚’ææ¡ˆã—ã¦ãã ã•ã„ã€‚

ã€ã‚¿ã‚¤ãƒˆãƒ«ã€‘
${title}

ã€ãƒ¬ã‚¹ç·æ•°ã€‘
${totalPosts}ä»¶

ã€å…¨ãƒ¬ã‚¹å†…å®¹ã€‘
${postsText}

ã€é¸æŠåŸºæº–ã€‘
- **ãƒ¬ã‚¹1ï¼ˆã‚¹ãƒ¬ç«‹ã¦ï¼‰ã¯å«ã‚ãªã„**ï¼ˆè‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™ï¼‰
- **ğŸ”¥ æœ€é‡è¦ï¼šã‚¹ãƒ¬ä¸»ï¼ˆ[ã‚¹ãƒ¬ä¸»]ãƒãƒ¼ã‚¯ä»˜ãï¼‰ã®ãƒ¬ã‚¹ã¯å„ªå…ˆçš„ã«é¸æŠã—ã¦ãã ã•ã„ ğŸ”¥**
  - ã‚¹ãƒ¬ä¸»ã®ãƒ¬ã‚¹ã¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®æ ¸å¿ƒã§ã‚ã‚Šã€çœç•¥ã™ã‚‹ã¨è©±ã®æµã‚ŒãŒåˆ†ã‹ã‚‰ãªããªã‚Šã¾ã™
  - ã‚¹ãƒ¬ä¸»ã®ãƒ¬ã‚¹ç•ªå·: ${ownerPostNumbers.length > 0 ? ownerPostNumbers.join(', ') : 'ãªã—'}
  - ã‚¹ãƒ¬ä¸»ã®ãƒ¬ã‚¹ã¯ç‰¹åˆ¥ãªç†ç”±ãŒãªã„é™ã‚Šå…¨ã¦é¸æŠã—ã¦ãã ã•ã„
- ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®æµã‚ŒãŒåˆ†ã‹ã‚‹ãƒ¬ã‚¹
- é¢ç™½ã„ãƒ»ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆã®ã‚ã‚‹ãƒ¬ã‚¹
- ã‚ªãƒã‚„ãƒ„ãƒƒã‚³ãƒŸã«ãªã‚‹ãƒ¬ã‚¹
- **>>ï¼ˆã‚¢ãƒ³ã‚«ãƒ¼ï¼‰ã‚’å«ã‚€ãƒ¬ã‚¹ã‚‚ã€ã¾ã¨ã‚ã«å¿…è¦ãªã‚‰å¿…ãšé¸æŠã—ã¦ãã ã•ã„**
- å…¨ä½“ã®30-50%ç¨‹åº¦ã«çµã‚‹ï¼ˆ${Math.floor(totalPosts * 0.3)}-${Math.floor(totalPosts * 0.5)}ä»¶ç¨‹åº¦ï¼‰

ã€é™¤å¤–åŸºæº– - ã“ã‚Œã‚‰ã®ãƒ¬ã‚¹ã¯çµ¶å¯¾ã«é¸æŠã—ãªã„ã“ã¨ã€‘
**ğŸš« æœ€é‡è¦ï¼šã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã¨ã®é–¢é€£æ€§ãƒã‚§ãƒƒã‚¯ ğŸš«**
- **ãƒ¬ã‚¹ã‚’é¸æŠã™ã‚‹å‰ã«ã€å¿…ãšã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${title}ã€ã¨ã®é–¢é€£æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„**
- **ã‚¿ã‚¤ãƒˆãƒ«ã®ãƒ†ãƒ¼ãƒã¨å…¨ãç„¡é–¢ä¿‚ãªè©±é¡Œã®ãƒ¬ã‚¹ã¯çµ¶å¯¾ã«é¸æŠã—ãªã„ã§ãã ã•ã„**

ä»¥ä¸‹ã®ãƒ¬ã‚¹ã¯çµ¶å¯¾ã«é¸æŠã—ãªã„ã“ã¨ï¼š
1. **ã‚¹ãƒ¬ãƒƒãƒ‰ã®ãƒ†ãƒ¼ãƒã‚„å†…å®¹ã«ç„¡é–¢ä¿‚ãªãƒ¬ã‚¹ï¼ˆæœ€ã‚‚é‡è¦ï¼ï¼‰**
   - ä¾‹ï¼šãƒã‚±ãƒ¢ãƒ³ã®ã‚¹ãƒ¬ã§ã€å›½éš›çµå©šã®çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
   - ä¾‹ï¼šã‚²ãƒ¼ãƒ ã®ã‚¹ãƒ¬ã§ã€å…¨ãé–¢ä¿‚ã®ãªã„æ”¿æ²»ã‚„æ­´å²ã®è©±é¡Œ
   - ä¾‹ï¼šã‚¹ãƒãƒ¼ãƒ„ã®ã‚¹ãƒ¬ã§ã€é£Ÿã¹ç‰©ã®è©±é¡Œ
   - **ğŸš« çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚„ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ã®ã‚³ãƒ”ãƒšï¼ˆç‰¹ã«æ³¨æ„ï¼ï¼‰ğŸš«**
     * ã€ã‚¢ãƒ¡ãƒªã‚«ã®å›½éš›çµå©šãƒ‡ãƒ¼ã‚¿ã€‘ã€çµ±è¨ˆã€‘ã®ã‚ˆã†ãªè¦‹å‡ºã—
     * ã€Œ1ä½â—‹â—‹ã€ã€Œ2ä½â–³â–³ã€ã€Œ3ä½Ã—Ã—ã€ã®ã‚ˆã†ãªãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼
     * ã€Œâ—‹â—‹ä¸‡äººã€ã€Œâ–³â–³%ã€ã®ã‚ˆã†ãªæ•°å€¤ãƒ‡ãƒ¼ã‚¿ã®ç¾…åˆ—
     * æ¤œå®šè©¦é¨“ã€å—é¨“è€…æ•°ã€äººå£çµ±è¨ˆã€å­¦ç¿’è€…æ•°ã€ç•™å­¦ç”Ÿæ•°ãªã©ã®ç®‡æ¡æ›¸ããƒ‡ãƒ¼ã‚¿
     * ã€Œåœ¨æ—¥â—‹â—‹äººã€ã€Œåœ¨éŸ“â—‹â—‹äººã€ã®ã‚ˆã†ãªå›½éš›æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿
     * ã€Œå›½ç±æ”¾æ£„è€…ã€ã€Œæ—¥æœ¬ç±ã€ã®ã‚ˆã†ãªæ”¿æ²»çš„çµ±è¨ˆãƒ‡ãƒ¼ã‚¿
     * ãƒ‰ãƒƒãƒˆï¼ˆ.ï¼‰ã§åŒºåˆ‡ã‚‰ã‚ŒãŸè¤‡æ•°è¡Œã®ãƒ‡ãƒ¼ã‚¿ç¾…åˆ—
   - **ã“ã‚Œã‚‰ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ†ãƒ¼ãƒã¨99%ç„¡é–¢ä¿‚ãªã‚¹ãƒ‘ãƒ ã§ã™ã€‚çµ¶å¯¾ã«é¸æŠã—ãªã„ã§ãã ã•ã„ã€‚**

2. **ã‚¹ãƒ‘ãƒ çš„ãªçŸ­æ–‡ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆ15æ–‡å­—æœªæº€ã¯ç‰¹ã«æ³¨æ„ï¼‰**
   - ä¾‹ï¼šã€Œã‚„ã‚ã¦ãã‚Œã€ã€Œã†ã–ã„ã€ã€Œæ¶ˆãˆã‚ã€ã€Œãªã‚“ã‚„ã‚³ã‚¤ãƒ„ã£ã¦ã‚“ã®ï¼Ÿã€ãªã©ã€è­°è«–ã«è²¢çŒ®ã—ãªã„ã‚‚ã®
   - ä¾‹ï¼šã€Œè‰ã€ã€Œã“ã‚Œã€ã€Œã‚ã‹ã‚‹ã€ã€Œãã‚Œãªã€ãªã©ã®ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ
   - **15æ–‡å­—æœªæº€ã®ãƒ¬ã‚¹ã¯ã€ã‚ˆã»ã©é‡è¦ã§ãªã„é™ã‚Šé¸æŠã—ãªã„ã§ãã ã•ã„**
   - **ãŸã ã—ã€ã‚ªãƒã‚„è½ã¡ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦æ©Ÿèƒ½ã™ã‚‹å ´åˆã¯ä¾‹å¤–**

3. **è’ã‚‰ã—ã‚„ç…½ã‚Šã®ã¿ã®ãƒ¬ã‚¹**
   - è­°è«–ã‚’å¦¨å®³ã™ã‚‹ç›®çš„ã®ã‚³ãƒ¡ãƒ³ãƒˆ
   - æ”»æ’ƒçš„ãƒ»ä¾®è¾±çš„ãªçŸ­æ–‡

4. **è©±ã®æµã‚Œã«å…¨ãé–¢ä¿‚ã®ãªã„ä¸€è¨€ã‚³ãƒ¡ãƒ³ãƒˆ**
   - ã‚¹ãƒ¬ãƒƒãƒ‰ã®æœ¬é¡Œã¨é–¢ä¿‚ãªã„é›‘è«‡
   - æ–‡è„ˆã‹ã‚‰åˆ‡ã‚Šé›¢ã•ã‚ŒãŸæ„å‘³ä¸æ˜ãªã‚³ãƒ¡ãƒ³ãƒˆ

5. **å®£ä¼ã‚„åºƒå‘Šç›®çš„ã®ãƒ¬ã‚¹**
   - å•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®å®£ä¼

**åˆ¤æ–­åŸºæº–ï¼š**
- ãƒ¬ã‚¹ã‚’é¸ã¶å‰ã«è‡ªå•ï¼šã€Œã“ã®ãƒ¬ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã€${title}ã€ã¨ç›´æ¥é–¢ä¿‚ãŒã‚ã‚‹ã‹ï¼Ÿã€
- ç­”ãˆãŒNoãªã‚‰ã€ãã®ãƒ¬ã‚¹ã¯é¸æŠã—ãªã„
- ã“ã‚Œã‚‰ã®ãƒ¬ã‚¹ã¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã®ç†è§£ã‚’å¦¨ã’ã€ã¾ã¨ã‚è¨˜äº‹ã®è³ªã‚’å¤§ããä¸‹ã’ã¾ã™

ã€é¸æŠå¾Œã®æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰ã€‘
ãƒ¬ã‚¹é¸æŠãŒå®Œäº†ã—ãŸã‚‰ã€selected_postsã®å„ãƒ¬ã‚¹ã‚’1ã¤ãšã¤ä»¥ä¸‹ã®é …ç›®ã§ç¢ºèªã—ã¦ãã ã•ã„ï¼š

âœ“ **é–¢é€£æ€§ãƒã‚§ãƒƒã‚¯**: ã“ã®ãƒ¬ã‚¹ã¯ã‚¹ãƒ¬ãƒƒãƒ‰ã‚¿ã‚¤ãƒˆãƒ«ã€Œ${title}ã€ã¨ç›´æ¥é–¢ä¿‚ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
  â†’ Noãªã‚‰å³åº§ã«å‰Šé™¤

âœ“ **æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯**: ã“ã®ãƒ¬ã‚¹ã¯15æ–‡å­—ä»¥ä¸Šã®æ„å‘³ã®ã‚ã‚‹å†…å®¹ã§ã™ã‹ï¼Ÿ
  â†’ Noã§ã€ã‹ã¤ã‚ªãƒã§ã‚‚ãªã„ãªã‚‰å‰Šé™¤

âœ“ **ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯**: ã“ã®ãƒ¬ã‚¹ã¯çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°å½¢å¼ã€ã¾ãŸã¯ç„¡é–¢ä¿‚ãªã‚³ãƒ”ãƒšã§ã™ã‹ï¼Ÿ
  â†’ Yesãªã‚‰å³åº§ã«å‰Šé™¤

âœ“ **ä¾¡å€¤ãƒã‚§ãƒƒã‚¯**: ã“ã®ãƒ¬ã‚¹ã¯ã¾ã¨ã‚è¨˜äº‹ã®èª­è€…ã«ã¨ã£ã¦ä¾¡å€¤ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ
  â†’ Noãªã‚‰å‰Šé™¤

**æœ€çµ‚ç¢ºèªï¼šé¸æŠã—ãŸãƒ¬ã‚¹ã®ä¸­ã«ã€ä¸Šè¨˜ã®é™¤å¤–åŸºæº–ã«è©²å½“ã™ã‚‹ã‚‚ã®ãŒ1ã¤ã§ã‚‚æ®‹ã£ã¦ã„ãªã„ã‹å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚**

ã€è‡ªå‹•å‡¦ç†ãƒ«ãƒ¼ãƒ« - ã“ã‚Œã‚‰ã¯è‡ªå‹•çš„ã«å‡¦ç†ã•ã‚Œã¾ã™ãŒã€åŸºæœ¬ã®ãƒ¬ã‚¹ã¯é¸æŠã—ã¦ãã ã•ã„ã€‘
**âš ï¸ é‡è¦ï¼šã‚¢ãƒ³ã‚«ãƒ¼ã‚’ã€Œå«ã‚€ãƒ¬ã‚¹ã€è‡ªä½“ã¯å¿…ãšé¸æŠã—ã¦ãã ã•ã„ âš ï¸**

1. **ãƒ¬ã‚¹1ï¼ˆã‚¹ãƒ¬ç«‹ã¦ï¼‰**: è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã€èµ¤è‰²ãŒè¨­å®šã•ã‚Œã¾ã™

2. **ã‚¢ãƒ³ã‚«ãƒ¼å…ˆã®è‡ªå‹•è¿½åŠ **:
   **ã‚ãªãŸãŒé¸æŠã—ãŸãƒ¬ã‚¹ã«>>æ•°å­—ãŒå«ã¾ã‚Œã¦ã„ã‚‹å ´åˆã€ãã®ã‚¢ãƒ³ã‚«ãƒ¼å…ˆã¯è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™**
   - ä¾‹ï¼šã‚ãªãŸãŒãƒ¬ã‚¹3ã€Œ>>2 ä½œæ›²ã¨é‡çƒã¿ã‚‹ã“ã¨ã€ã‚’é¸æŠã—ãŸå ´åˆ
     â†’ ãƒ¬ã‚¹2ã€Œè¶£å‘³ã¯ï¼Ÿã€ãŒè‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™

   **ãŸã ã—ã€ã‚¢ãƒ³ã‚«ãƒ¼ã‚’å«ã‚€ãƒ¬ã‚¹è‡ªä½“ï¼ˆä¾‹ï¼šãƒ¬ã‚¹3ï¼‰ã¯å¿…ãšé¸æŠã—ã¦ãã ã•ã„**
   **ã‚¢ãƒ³ã‚«ãƒ¼å…ˆï¼ˆä¾‹ï¼šãƒ¬ã‚¹2ï¼‰ã ã‘ãŒè‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™**

3. **å¾Œæ–¹å‚ç…§ã®è‡ªå‹•è¿½åŠ **:
   é¸æŠæ¸ˆã¿ã®ãƒ¬ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãƒ¬ã‚¹ã‚‚è‡ªå‹•è¿½åŠ ã•ã‚Œã¾ã™
   - ä¾‹ï¼šãƒ¬ã‚¹10ã‚’é¸æŠæ¸ˆã¿ã€ãƒ¬ã‚¹20ãŒã€Œ>>10ã€ã‚’å«ã‚€å ´åˆ
     â†’ ãƒ¬ã‚¹20ã‚‚è‡ªå‹•çš„ã«è¿½åŠ ã•ã‚Œã¾ã™

4. **å†å¸°çš„æ¤œå‡º**:
   è‡ªå‹•è¿½åŠ ã•ã‚ŒãŸãƒ¬ã‚¹ã‹ã‚‰ã•ã‚‰ã«ã‚¢ãƒ³ã‚«ãƒ¼ãŒè¦‹ã¤ã‹ã‚Œã°ã€ãã‚Œã‚‚è‡ªå‹•è¿½åŠ 

5. **è½ã¡ã‚³ãƒ¡ãƒ³ãƒˆ**:
   æœ€å¾Œã®ãƒ¬ã‚¹ï¼ˆã‚¹ãƒ¬ã®æœ€çµ‚ãƒ¬ã‚¹ï¼‰ã¯è‡ªå‹•çš„ã«èµ¤è‰²ãŒè¨­å®šã•ã‚Œã¾ã™

ã€è£…é£¾ãƒ«ãƒ¼ãƒ«ã€‘
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ**: é¸æŠã—ãŸãƒ¬ã‚¹ã¯å…¨ã¦ã€Œå¤ªå­—ã€ã¨ã€Œæ–‡å­—ã‚µã‚¤ã‚ºä¸­ã€ã‚’é©ç”¨
- ãã®ä¸Šã§ã€å†…å®¹ã«å¿œã˜ã¦è¿½åŠ è£…é£¾ï¼š
  * ãƒ¬ã‚¹1ï¼ˆã‚¹ãƒ¬ç«‹ã¦ï¼‰ â†’ "red"ï¼ˆèµ¤è‰²ã€è‡ªå‹•è¨­å®šï¼‰
  * é¢ç™½ã„ãƒ„ãƒƒã‚³ãƒŸãƒ»å°è±¡çš„ãªç™ºè¨€ â†’ "red"ï¼ˆèµ¤è‰²ï¼‰
  * è£œè¶³èª¬æ˜ãƒ»å†·é™ãªæŒ‡æ‘˜ â†’ "blue"ï¼ˆé’è‰²ï¼‰
  * ç‚ºã«ãªã‚‹ãƒ»å‚è€ƒã«ãªã‚‹ãƒ»å‹‰å¼·ã«ãªã‚‹ãƒ»å½¹ç«‹ã¤ã‚³ãƒ¡ãƒ³ãƒˆ â†’ "green"ï¼ˆç·‘è‰²ï¼‰
  * ã‚¢ãƒ³ã‚«ãƒ¼å…ˆã¨ã—ã¦è¿½åŠ ã•ã‚ŒãŸãƒ¬ã‚¹ â†’ è‰²ã¯è‡ªå‹•è¨­å®šã•ã‚Œã¾ã™
  * æœ€å¾Œã®ãƒ¬ã‚¹ï¼ˆè½ã¡ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ â†’ "red"ï¼ˆè‡ªå‹•è¨­å®šï¼‰
  * **é‡è¦ã§ãªã„ãƒ¬ã‚¹ãƒ»è£œè¶³çš„ãªãƒ¬ã‚¹ãƒ»æ·¡ã€…ã¨ã—ãŸèª¬æ˜ã®ã¿ã®ãƒ¬ã‚¹ â†’ nullï¼ˆè‰²ãªã—ï¼‰**

ã€è‰²ã‚’ä»˜ã‘ã‚‹ã‹ã©ã†ã‹ã®åˆ¤æ–­åŸºæº– - é‡è¦ï¼ã€‘
- **è‰²ã¯ã€Œéå¸¸ã«é¢ç™½ã„ã€ã€Œéå¸¸ã«å°è±¡çš„ã€ã€Œéå¸¸ã«é‡è¦ã€ãªãƒ¬ã‚¹ã«ã®ã¿ä»˜ã‘ã¦ãã ã•ã„**
- **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯nullï¼ˆè‰²ãªã—ï¼‰ã§ã™ã€‚è¿·ã£ãŸã‚‰nullã«ã—ã¦ãã ã•ã„**
- ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ¬ã‚¹ã«ã¯çµ¶å¯¾ã«è‰²ã‚’ä»˜ã‘ãšã€null ã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼š
  * å˜ãªã‚‹è£œè¶³èª¬æ˜ã‚„æ·¡ã€…ã¨ã—ãŸæƒ…å ±æä¾›ã®ã¿ã®ãƒ¬ã‚¹
  * ä¼šè©±ã®æµã‚Œã‚’ç¹‹ãã ã‘ã®é‡è¦åº¦ãŒä½ã„ãƒ¬ã‚¹
  * ç‰¹ã«å°è±¡ã«æ®‹ã‚‰ãªã„å¹³å‡¡ãªãƒ¬ã‚¹
  * å‰ã®ãƒ¬ã‚¹ã¨åŒã˜è‰²ã«ãªã£ã¦ã—ã¾ã†å ´åˆï¼ˆæœ€å„ªå…ˆï¼ï¼‰
- **è‰²ä»˜ãã®ãƒ¬ã‚¹ã¯å…¨ä½“ã®30-40%ç¨‹åº¦ã«æŠ‘ãˆã¦ãã ã•ã„ï¼ˆè‰²ãªã—ã®ãƒ¬ã‚¹ãŒéåŠæ•°ã§OKï¼‰**
- **é€£ç¶šã—ãŸè‰²ã‚’é¿ã‘ã‚‹ãŸã‚ã€nullã‚’ç©æ¥µçš„ã«æ´»ç”¨ã—ã¦ãã ã•ã„**

ã€ã‚µã‚¤ã‚ºãƒ–ãƒ¼ã‚¹ãƒˆãƒ«ãƒ¼ãƒ« - æ…é‡ã«ä½¿ç”¨ã™ã‚‹ã“ã¨ã€‘
- **"size_boost": "large"ï¼ˆã‚µã‚¤ã‚ºå¤§ï¼‰ã¯éå¸¸ã«ç‰¹åˆ¥ãªãƒ¬ã‚¹ã®ã¿ã«ä½¿ç”¨**
- ä½¿ç”¨ä¾‹ï¼š
  * ã‚¹ãƒ¬å…¨ä½“ã®ã‚¯ãƒ©ã‚¤ãƒãƒƒã‚¯ã‚¹ãƒ»ã‚ªãƒã¨ãªã‚‹æ±ºå®šçš„ãªç™ºè¨€
  * åœ§å€’çš„ãªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒã‚ã‚Šã€èª°ã‚‚ãŒé©šãã‚ˆã†ãªç™ºè¨€
  * ã‚¹ãƒ¬ã®çµè«–ãƒ»ã¾ã¨ã‚ã¨ãªã‚‹é‡è¦ãªç™ºè¨€
- **åŸå‰‡ã¨ã—ã¦å…¨ãƒ¬ã‚¹ã®5-10%ä»¥ä¸‹ï¼ˆ0-2ä»¶ç¨‹åº¦ï¼‰ã«é™å®šã—ã¦ãã ã•ã„**
- è¿·ã£ãŸã‚‰"size_boost": nullã«ã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ã‚µã‚¤ã‚ºä¸­ï¼‰

ã€è‰²ã®ä½¿ç”¨ãƒ«ãƒ¼ãƒ« - æœ€é‡è¦ï¼å¿…ãšå®ˆã‚‹ã“ã¨ã€‘
- **ä½¿ç”¨ã§ãã‚‹è‰²ã¯ã€Œredã€ã€Œblueã€ã€Œgreenã€ã€Œnullã€ã®4ç¨®é¡ã®ã¿ã§ã™**

**ğŸš¨ é€£ç¶šã—ãŸè‰²ã®ç¦æ­¢ãƒ«ãƒ¼ãƒ«ï¼ˆæœ€å„ªå…ˆäº‹é …ï¼‰ğŸš¨**
- **çµ¶å¯¾ã«é€£ç¶šã™ã‚‹ãƒ¬ã‚¹ç•ªå·ã«åŒã˜è‰²ã‚’å‰²ã‚Šå½“ã¦ãªã„ã§ãã ã•ã„**
- **ã“ã‚Œã¯èª­ã¿ã‚„ã™ã•ã«ç›´çµã™ã‚‹æœ€ã‚‚é‡è¦ãªãƒ«ãƒ¼ãƒ«ã§ã™**
- **é€£ç¶šã—ãŸè‰²ã«ãªã‚Šãã†ãªå ´åˆã¯ã€è¿·ã‚ãšnullã‚’é¸ã‚“ã§ãã ã•ã„**
- ä¾‹ï¼šãƒ¬ã‚¹3ãŒèµ¤è‰²ã®å ´åˆã€ãƒ¬ã‚¹5ã¯é’è‰²ãƒ»ç·‘è‰²ãƒ»nullã®ã„ãšã‚Œã‹ã«ã™ã‚‹ï¼ˆèµ¤è‰²ã¯çµ¶å¯¾ç¦æ­¢ï¼‰
- ä¾‹ï¼šãƒ¬ã‚¹10ãŒé’è‰²ã®å ´åˆã€ãƒ¬ã‚¹12ã¯èµ¤è‰²ãƒ»ç·‘è‰²ãƒ»nullã®ã„ãšã‚Œã‹ã«ã™ã‚‹ï¼ˆé’è‰²ã¯çµ¶å¯¾ç¦æ­¢ï¼‰

**è‰²ä»˜ã‘ã®å„ªå…ˆé †ä½ï¼ˆé‡è¦ï¼‰**
1. **ã¾ãšå…¨ã¦ã®ãƒ¬ã‚¹ã®è‰²ã‚’nullã«è¨­å®šã™ã‚‹**
2. **ãã®ä¸­ã‹ã‚‰æœ¬å½“ã«é‡è¦ãƒ»å°è±¡çš„ãªãƒ¬ã‚¹ã«ã®ã¿è‰²ã‚’ä»˜ã‘ã‚‹**
3. **è‰²ã‚’ä»˜ã‘ã‚‹éš›ã¯ã€å¿…ãšå‰ã®ãƒ¬ã‚¹ã¨ç•°ãªã‚‹è‰²ã‚’é¸ã¶**
4. **è¿·ã£ãŸã‚‰nullã®ã¾ã¾ã«ã™ã‚‹ï¼ˆè‰²ãªã—ã®ãƒ¬ã‚¹ãŒ50%ä»¥ä¸Šã‚ã£ã¦ã‚‚å•é¡Œã‚ã‚Šã¾ã›ã‚“ï¼‰**

**æœ€çµ‚ãƒã‚§ãƒƒã‚¯ï¼ˆå¿…é ˆï¼‰**
- è‰²ä»˜ã‘ãŒå®Œäº†ã—ãŸã‚‰ã€selected_postsã‚’ç•ªå·é †ã«ä¸¦ã¹ã¦ä»¥ä¸‹ã‚’ç¢ºèªï¼š
  1. é€£ç¶šã—ãŸè‰²ãŒãªã„ã‹ï¼Ÿ
  2. ã‚‚ã—é€£ç¶šã—ã¦ã„ãŸã‚‰ã€å¾Œã‚ã®ãƒ¬ã‚¹ã‚’nullã¾ãŸã¯åˆ¥ã®è‰²ã«å¤‰æ›´ã™ã‚‹
- **ã“ã®ãƒã‚§ãƒƒã‚¯ã‚’å¿…ãšè¡Œã£ã¦ãã ã•ã„ã€‚ã“ã‚ŒãŒæœ€ã‚‚é‡è¦ã§ã™ã€‚**

ä»¥ä¸‹ã®JSONå½¢å¼ã§è¿”ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "selected_posts": [
    {
      "post_number": 1,
      "decorations": {
        "color": "red",
        "size_boost": null
      },
      "reason": "é¸æŠç†ç”±"
    }
  ]
}

ã€é‡è¦ãªå‡ºåŠ›ãƒ«ãƒ¼ãƒ«ã€‘
1. **å¿…ãšJSONå½¢å¼ã®ã¿ã§è¿”ç­”ã—ã¦ãã ã•ã„ã€‚èª¬æ˜æ–‡ã¯ä¸€åˆ‡ä¸è¦ã§ã™ã€‚**
2. **JSONã¯å¿…ãšå®Œå…¨ãªå½¢å¼ã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚é€”ä¸­ã§åˆ‡ã‚Œãªã„ã‚ˆã†ã«æ³¨æ„ã—ã¦ãã ã•ã„ã€‚**
3. **é…åˆ—ã®æœ€å¾Œã®è¦ç´ ã«ã‚‚ã‚«ãƒ³ãƒã‚’ä»˜ã‘ãªã„ã§ãã ã•ã„ã€‚**
4. **ã™ã¹ã¦ã®æ³¢æ‹¬å¼§ {} ã¨è§’æ‹¬å¼§ [] ã‚’æ­£ã—ãé–‰ã˜ã¦ãã ã•ã„ã€‚**
5. **æ–‡å­—åˆ—ã¯å¿…ãšãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆ "" ã§å›²ã‚“ã§ãã ã•ã„ã€‚**
6. **ãƒ¬ã‚¹æ•°ãŒå¤šã„å ´åˆã§ã‚‚ã€selected_postsé…åˆ—ã‚’é€”ä¸­ã§åˆ‡ã‚‰ãªã„ã§ãã ã•ã„ã€‚**

å‡ºåŠ›ä¾‹ï¼š
{"selected_posts":[{"post_number":2,"decorations":{"color":"blue","size_boost":null},"reason":"ç†ç”±"}]}

ä¸Šè¨˜ã®ãƒ«ãƒ¼ãƒ«ã‚’å³å®ˆã—ã€å®Œå…¨ã§æœ‰åŠ¹ãªJSONã®ã¿ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚`;
}

// AIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’å¼·åŒ–ï¼ˆãƒ¬ã‚¹1è¿½åŠ ã€ã‚¢ãƒ³ã‚«ãƒ¼å…ˆè¿½åŠ ãªã©ï¼‰
export function enhanceAIResponse(
  aiResponse: AISummarizeResponse,
  comments: Comment[]
): AISummarizeResponse {
  const selectedPosts = [...aiResponse.selected_posts];
  const selectedNumbers = new Set(selectedPosts.map(p => p.post_number));
  const totalPosts = comments.length;

  // ãƒ¬ã‚¹1ã‚’è¿½åŠ ï¼ˆãªã‘ã‚Œã°ï¼‰
  if (!selectedNumbers.has(1)) {
    selectedPosts.unshift({
      post_number: 1,
      decorations: { color: 'red', size_boost: null },
      reason: 'ã‚¹ãƒ¬ç«‹ã¦ï¼ˆè‡ªå‹•è¿½åŠ ï¼‰'
    });
    selectedNumbers.add(1);
  } else {
    // ãƒ¬ã‚¹1ãŒã‚ã‚Œã°èµ¤è‰²ã«è¨­å®š
    const post1 = selectedPosts.find(p => p.post_number === 1);
    if (post1) {
      post1.decorations.color = 'red';
    }
  }

  // ã‚¢ãƒ³ã‚«ãƒ¼å…ˆã‚’å†å¸°çš„ã«è¿½åŠ ï¼ˆæœ€å¤§3éšå±¤ï¼‰
  const addAnchorTargets = (depth: number = 0) => {
    if (depth >= 3) return;

    const newPosts: typeof selectedPosts = [];

    for (const post of selectedPosts) {
      const comment = comments[post.post_number - 1];
      if (!comment) continue;

      // >>æ•°å­— ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡º
      const anchorMatches = comment.body.match(/>>(\d+)/g);
      if (anchorMatches) {
        for (const match of anchorMatches) {
          const targetNum = parseInt(match.replace('>>', ''));
          if (targetNum > 0 && targetNum <= totalPosts && !selectedNumbers.has(targetNum)) {
            newPosts.push({
              post_number: targetNum,
              decorations: { color: null, size_boost: null },
              reason: `ã‚¢ãƒ³ã‚«ãƒ¼å…ˆï¼ˆ>>ã‹ã‚‰è‡ªå‹•è¿½åŠ ï¼‰`
            });
            selectedNumbers.add(targetNum);
          }
        }
      }
    }

    if (newPosts.length > 0) {
      selectedPosts.push(...newPosts);
      addAnchorTargets(depth + 1);
    }
  };

  addAnchorTargets();

  // å¾Œæ–¹å‚ç…§ã‚’è¿½åŠ ï¼ˆé¸æŠæ¸ˆã¿ãƒ¬ã‚¹ã‚’å‚ç…§ã—ã¦ã„ã‚‹ãƒ¬ã‚¹ï¼‰
  for (let i = 0; i < comments.length; i++) {
    const comment = comments[i];
    const postNum = i + 1;

    if (selectedNumbers.has(postNum)) continue;

    const anchorMatches = comment.body.match(/>>(\d+)/g);
    if (anchorMatches) {
      for (const match of anchorMatches) {
        const targetNum = parseInt(match.replace('>>', ''));
        if (selectedNumbers.has(targetNum)) {
          selectedPosts.push({
            post_number: postNum,
            decorations: { color: null, size_boost: null },
            reason: `å¾Œæ–¹å‚ç…§ï¼ˆè‡ªå‹•è¿½åŠ ï¼‰`
          });
          selectedNumbers.add(postNum);
          break;
        }
      }
    }
  }

  // æœ€å¾Œã®ãƒ¬ã‚¹ï¼ˆè½ã¡ã‚³ãƒ¡ãƒ³ãƒˆï¼‰ã‚’èµ¤è‰²ã«
  const lastPostNum = totalPosts;
  const lastPost = selectedPosts.find(p => p.post_number === lastPostNum);
  if (lastPost) {
    lastPost.decorations.color = 'red';
  }

  // é€£ç¶šã—ãŸè‰²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ä¿®æ­£
  selectedPosts.sort((a, b) => a.post_number - b.post_number);
  let prevColor: string | null = null;
  for (const post of selectedPosts) {
    if (post.decorations.color && post.decorations.color === prevColor) {
      post.decorations.color = null; // é€£ç¶šã—ãŸè‰²ã¯nullã«
    }
    prevColor = post.decorations.color;
  }

  return { selected_posts: selectedPosts };
}

// Claude APIã‚’å‘¼ã³å‡ºã—
export async function callClaudeAPI(
  apiKey: string,
  title: string,
  comments: Comment[]
): Promise<AISummarizeResponse> {
  const prompt = buildAISummarizePrompt(title, comments);

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'x-api-key': apiKey,
      'anthropic-version': '2023-06-01',
      'content-type': 'application/json',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-haiku-4-5-20251001',
      max_tokens: 8000,
      messages: [
        {
          role: 'user',
          content: prompt
        }
      ]
    })
  });

  if (!response.ok) {
    const error = await response.json();
    if (response.status === 529) {
      throw new Error('APIãŒæ··é›‘ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
    }
    if (response.status === 401) {
      throw new Error('APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚è¨­å®šãƒšãƒ¼ã‚¸ã§æ­£ã—ã„APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
    }
    throw new Error(error.error?.message || 'APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
  }

  const data = await response.json();
  const content = data.content[0]?.text || '';

  // JSONã‚’ãƒ‘ãƒ¼ã‚¹
  let jsonStr = content;

  // ```json ãƒ–ãƒ­ãƒƒã‚¯ã‚’é™¤å»
  const jsonMatch = content.match(/```json\s*([\s\S]*?)\s*```/);
  if (jsonMatch) {
    jsonStr = jsonMatch[1];
  }

  try {
    const parsed = JSON.parse(jsonStr);
    return enhanceAIResponse(parsed, comments);
  } catch {
    // ä¸å®Œå…¨ãªJSONã‚’ä¿®å¾©
    const repaired = repairIncompleteJson(jsonStr);
    const parsed = JSON.parse(repaired);
    return enhanceAIResponse(parsed, comments);
  }
}

// ä¸å®Œå…¨ãªJSONã‚’ä¿®å¾©
function repairIncompleteJson(jsonStr: string): string {
  let str = jsonStr.trim();

  // æœ€å¾Œã®ä¸å®Œå…¨ãªè¦ç´ ã‚’å‰Šé™¤
  const lastCompleteIndex = str.lastIndexOf('}');
  if (lastCompleteIndex > 0) {
    str = str.substring(0, lastCompleteIndex + 1);
  }

  // é–‰ã˜æ‹¬å¼§ã‚’è¿½åŠ 
  const openBraces = (str.match(/{/g) || []).length;
  const closeBraces = (str.match(/}/g) || []).length;
  const openBrackets = (str.match(/\[/g) || []).length;
  const closeBrackets = (str.match(/\]/g) || []).length;

  str += '}'.repeat(Math.max(0, openBraces - closeBraces));
  str += ']'.repeat(Math.max(0, openBrackets - closeBrackets));

  return str;
}
