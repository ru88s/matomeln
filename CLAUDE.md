# シクマト開発ルール

## UI/UXデザイン原則

### 1. シンプルさを保つ
- コメント検索機能は不要
- すべてのコメントを一つのリストで表示する
- 選択中のみ表示機能はトグルボタンで提供

### 2. キーボードショートカット
- Space: 最後にホバーしたコメントを選択/解除
- Ctrl+E: ホバー中のコメントを編集
- 1-9: カラーパレット選択（順番通り）
- 0: 黒色（パレット最後）を選択
- Q: 文字サイズを小に変更（14px）
- W: 文字サイズを中に変更（18px）
- E: 文字サイズを大に変更（22px）
- Ctrl+Enter: 編集を保存
- Ctrl+C: 編集をキャンセル

### 3. カラーパレット
```javascript
const colorPalette = [
  '#ef4444', // 1: 赤
  '#3b82f6', // 2: 青
  '#a855f7', // 3: 紫
  '#22c55e', // 4: 緑
  '#ec4899', // 5: ピンク
  '#f97316', // 6: オレンジ
  '#eab308', // 7: 黄色
  '#06b6d4', // 8: シアン
  '#64748b', // 9: グレー
  '#000000', // 0: 黒
];
```

### 4. 並べ替え機能
- アンカー（>>番号）に基づいた自動並び替えを実装
- 返信コメントはインデントして表示（ml-8 border-l-2 border-sky-200 pl-4）
- 返信コメントは該当番号の下に自動配置
- **重要**: すべてのコメントを必ず表示する（アンカーの有無に関わらず）
- 再帰的な処理で階層構造を正しく構築
- 孤立したコメントも救済して表示
- 選択中のみ表示時はドラッグ&ドロップで手動並び替え可能

### 5. 編集ボタンの配置
- テキストエリアの右側に配置（-right-8）
- ホバー時のみ表示
- Eキーのヒントを表示

### 6. モーダル表示
- React Portalを使用してbody直下にレンダリング
- z-index: 9999（オーバーレイ）、10000（コンテンツ）
- ビューポート中央に固定表示

### 7. ヘッダーデザイン
- Betaバッジは「シクマト」の直後に配置
- サブタイトル「シクトクのまとめ作成ツール」を追加
- 「対応希望の掲示板募集中！」メッセージを表示

### 8. 表示ルール
- ID表示はトークの設定に依存（show_id）
- 時刻表示は必須（秒まで表示）
- コメント番号は「1.」形式（#ではなくピリオド）
- コメント番号、名前、時刻、IDを一行で表示

### 9. 編集モード
- エディタ外クリックで編集解除
- 編集中はコメント選択状態を変更しない
- 白背景のテキストエリア

### 10. 絵文字の使用
- 絵文字は基本的に使用しない
- ユーザーが明示的に要求した場合のみ使用

### 11. リンクとアンカー
- URL（http://、https://）は自動的に青色リンク化（#3b82f6）
- アンカー（>>番号）は青色表示（#3b82f6）、下線なし
- リンクはtarget="_blank"で新規タブで開く

### 12. レスの並び替えモード
- チェックボックスでモード切り替え
- 有効時は選択したコメントのみ表示
- ドラッグ&ドロップで順番変更可能
- ラベル表記：「レスの並び替え (選択済みのレスが表示)」

## HTML生成ルール

### ブログ投稿フォーマット
- 各コメントは`<div class="res_div">`で囲む
- コメント間に`<br /><br />`を追加して改行
- 本文と「続きを読む」は`<!--more-->`タグで分割
- 1つ目のコメントが本文、2つ目以降が「続きを読む」部分

### 画像処理
- 最大幅・高さ200pxに制限
- ShikutokuのCDN URLを使用

## ライブドアブログAPI仕様

### 認証方式
- **プロトコル**: AtomPub API（WSSE認証）
- **エンドポイント**: `https://livedoor.blogcms.jp/atom/blog/{blogId}/article`
- **認証ヘッダー**: WSSEトークン（UsernameToken形式）

### レスポンス処理
- 成功: HTTPステータス201とLocationヘッダー
- エラー: 401は認証エラー
- XML形式でペイロード送信

### XML構造
```xml
<entry xmlns="http://www.w3.org/2005/Atom">
  <title>{タイトル}</title>
  <content type="text/html">{全文}</content>
  <blogcms:source>
    <blogcms:body><![CDATA[{本文}]]></blogcms:body>
    <blogcms:more><![CDATA[{続き}]]></blogcms:more>
  </blogcms:source>
</entry>
```

## コーディング規約

### TypeScript/React
- 'use client'ディレクティブを使用
- createPortalでモーダルを実装
- useCallbackで関数をメモ化
- イベントのcaptureフェーズを適切に使用

### Tailwind CSS
- グラデーション: from-sky-50 to-cyan-50
- ボーダー: border-sky-100/200/300
- ホバー効果は明示的に定義
- z-indexは明確に定義（1000, 9999, 10000）

### パフォーマンス
- 不要な機能は削除
- フィルタリング機能は実装しない

## API設計

### エンドポイント
- `/api/proxy/getTalk` - トーク情報取得
- `/api/proxy/getComments` - コメント取得
- `/api/proxy/postBlog` - ブログ投稿

### 開発環境設定
- `app-api`ディレクトリを`app/api`にコピー（開発時のみ）
- `scripts/dev-setup.sh`で自動セットアップ
- Cloudflare Functionsは`functions`ディレクトリで管理

## テストコマンド
```bash
npm run dev  # 開発サーバー起動
npm run build  # ビルド
```

## 今後の方針
- UIのシンプルさを最優先
- ユーザーの明示的な要求のみ実装
- 不要な機能は積極的に削除
- キーボード操作の改善を継続